<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>My Invoices</title>
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/bookings-overview.css}">
    <style>
        body {
            background-color: #f5f5f5 !important;
        }

        .invoice-container {
            max-width: 1200px;
            margin: 80px auto;
            padding: 20px;
            color: #333 !important;
        }

        .invoice-container h1,
        .invoice-container h2,
        .invoice-container h3,
        .invoice-container p,
        .no-bookings {
            color: #333 !important;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .invoice-table th {
            background: #2c3e50;
            color: white !important;
            padding: 12px;
            text-align: left;
        }

        .invoice-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            color: #333 !important;
        }

        .invoice-table td span {
            color: #333 !important;
        }

        .payment-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .badge-paid {
            background: #27ae60;
            color: white;
        }

        .badge-partial {
            background: #f39c12;
            color: white;
        }

        .badge-unpaid {
            background: #e74c3c;
            color: white;
        }

        .price-highlight {
            font-weight: bold;
            color: #27ae60;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .toast-success, .toast-error {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            z-index: 3000;
        }

        .toast-success {
            background: #27ae60;
        }

        .toast-error {
            background: #e74c3c;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 5000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
            padding: 20px 0;
        }

        .modal-content {
            background-color: white;
            margin: 20px auto;
            padding: 30px;
            border-radius: 8px;
            width: 80%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            color: #333;
            position: relative;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #000;
        }

        .split-options {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        .split-option {
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            padding: 20px;
            background: #f8f9fa;
        }

        .split-option h3 {
            margin-top: 0;
            color: #2c3e50;
        }

        .split-option p {
            color: #666;
            margin: 10px 0;
        }

        .btn-split {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }

        .btn-split:hover {
            background: #2980b9;
        }

        .equipment-list {
            margin: 15px 0;
        }

        .equipment-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .equipment-item label {
            display: flex;
            align-items: center;
            cursor: pointer;
            color: #333;
        }

        .equipment-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
    </style>
</head>

<body>

<div th:replace="~{events/fragments/navbar :: navbar}"></div>

<div th:if="${success}" class="toast-success">
    <span th:text="${success}"></span>
</div>

<div th:if="${error}" class="toast-error">
    <span th:text="${error}"></span>
</div>

<div class="invoice-container">
    <h1>My Invoices</h1>

    <p th:if="${bookings == null || bookings.size() == 0}" class="no-bookings">
        You don't have any invoices yet
    </p>

    <table th:if="${bookings != null && bookings.size() > 0}" class="invoice-table">
        <thead>
        <tr>
            <th>Event</th>
            <th>Date</th>
            <th>Total Price</th>
            <th>Paid Amount</th>
            <th>Remaining</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="dto : ${bookings}">
            <td>
                <span th:text="${dto.event.title}">Event Title</span>
            </td>

            <td th:text="${dto.event.date}">2024-01-01</td>

            <td>
                <span th:text="${#numbers.formatDecimal(dto.totalPrice, 1, 2, 'COMMA')} + ' €'">0.00 €</span>
            </td>

            <td>
                <span th:text="${#numbers.formatDecimal(dto.paidAmount, 1, 2, 'COMMA')} + ' €'">0.00 €</span>
            </td>

            <td class="price-highlight">
                <span th:text="${#numbers.formatDecimal(dto.totalPrice - dto.paidAmount, 1, 2, 'COMMA')} + ' €'">0.00 €</span>
            </td>

            <td>
                <span th:if="${dto.paymentStatus.name() == 'PAID'}" class="payment-badge badge-paid">PAID</span>
                <span th:if="${dto.paymentStatus.name() == 'PARTIALLY_PAID'}" class="payment-badge badge-partial">PARTIAL</span>
                <span th:if="${dto.paymentStatus.name() == 'UNPAID' || dto.paymentStatus.name() == 'PENDING'}" class="payment-badge badge-unpaid">UNPAID</span>
            </td>

            <td>
                <button th:if="${dto.paymentStatus.name() != 'PAID'}"
                        class="btn-primary"
                        th:onclick="'openSplitModal(' + ${dto.id} + ')'">
                    Split Invoice
                </button>
                <span th:if="${dto.paymentStatus.name() == 'PAID'}" class="payment-badge badge-paid">✓ Fully Paid</span>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- Split Invoice Modal -->
<div id="splitModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeSplitModal()">&times;</span>
        <h2>Split Invoice Options</h2>

        <div class="split-options">
            <!-- Option 1: Pay 50% -->
            <div class="split-option">
                <h3>Pay 50% Now</h3>
                <p>Pay half of the total amount now, and the rest on the event day.</p>
                <form id="pay50Form" method="post" style="display:inline;">
                    <button type="submit" class="btn-split">Pay 50%</button>
                </form>
            </div>

            <!-- Option 2: Select Equipment -->
            <div class="split-option">
                <h3>Pay Selected Equipment</h3>
                <p>Choose specific equipment items to pay separately.</p>
                <form id="payEquipmentForm" method="post">
                    <div id="equipmentList" class="equipment-list">
                        <!-- Equipment items will be populated here -->
                    </div>
                    <button type="submit" class="btn-split">Pay Selected Items</button>
                </form>
            </div>

            <!-- Option 3: Pay Remaining -->
            <div class="split-option">
                <h3>Pay Remaining Amount</h3>
                <p>Pay the full remaining balance.</p>
                <form id="payRemainingForm" method="post" style="display:inline;">
                    <button type="submit" class="btn-split">Pay All</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const bookingsData = /*[[${bookings}]]*/ [];

    function openSplitModal(bookingId) {
        const modal = document.getElementById('splitModal');
        const booking = bookingsData.find(b => b.id === bookingId);

        if (!booking) return;

        // Set form actions
        document.getElementById('pay50Form').action = `/invoices/${bookingId}/split/fifty-percent`;
        document.getElementById('payEquipmentForm').action = `/invoices/${bookingId}/split/equipment`;
        document.getElementById('payRemainingForm').action = `/invoices/${bookingId}/pay-remaining`;

        // Populate equipment list
        const equipmentList = document.getElementById('equipmentList');
        equipmentList.innerHTML = '';

        if (booking.equipment && booking.equipment.length > 0) {
            booking.equipment.forEach(eq => {
                const div = document.createElement('div');
                div.className = 'equipment-item';
                div.innerHTML = `
                    <label>
                        <input type="checkbox" name="equipmentIds" value="${eq.equipmentId}">
                        Equipment ID: ${eq.equipmentId} - ${eq.quantity}x (${eq.totalPrice.toFixed(2)} €)
                    </label>
                `;
                equipmentList.appendChild(div);
            });
        } else {
            equipmentList.innerHTML = '<p>No equipment in this booking.</p>';
        }

        modal.style.display = 'block';
    }

    function closeSplitModal() {
        document.getElementById('splitModal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('splitModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    }

    setTimeout(() => {
        const toasts = document.querySelectorAll('.toast-success, .toast-error');
        toasts.forEach(toast => toast.style.display = 'none');
    }, 5000);
    /*]]>*/
</script>

</body>
</html>
