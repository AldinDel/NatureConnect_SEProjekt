<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>NatureConnect - Events</title>
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/events.css}">  <!-- ALLES IST HIER DRIN -->
    <link rel="icon" type="image/png" th:href="@{/images/NatureConnectLogo.png}" href="/images/NatureConnectLogo.png">
</head>

<body class="events-page">
<div th:replace="events/fragments/navbar :: navbar"></div>

<div th:if="${success != null}" id="success-popup" class="popup-message" th:text="${success}"></div>
<div th:if="${error != null}" id="error-popup" class="popup-message error" th:text="${error}"></div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const popup = document.getElementById("success-popup");
        const errorPopup = document.getElementById("error-popup");
        if (popup) setTimeout(() => popup.style.display = "none", 3000);
        if (errorPopup) setTimeout(() => errorPopup.style.display = "none", 3500);
    });
</script>




<section class="event-overview">
    <a th:href="@{/}" href="/" class="back-link">‚ùÆ Home</a>

    <h1 th:if="${showCancelled}" style="color: #0f2740;">
        üìã Backoffice - All Events
        <span style="font-size: 14px; font-weight: normal; color: #666; display: block; margin-top: 4px;">
            Including cancelled events
        </span>
    </h1>
    <h1 th:unless="${showCancelled}">Event Overview</h1>

    <p th:unless="${showCancelled}">Discover exciting events and activities near you</p>


    <!-- SEARCH + CATEGORY FILTERS -->
    <form th:action="@{/events/search}" method="get" class="search-form">

        <div class="search-bar">
            <i data-lucide="search" class="search-icon"></i>
            <input type="text" name="q" placeholder="Browse Events..." th:value="${param.q}">
        </div>

        <div class="category-bar">
            <button type="submit" name="category" value="" th:classappend="${param.category == null || param.category == ''} ? 'active'">All Events</button>
            <button type="submit" name="category" value="Camping" th:classappend="${param.category == 'Camping'} ? 'active'">Camping</button>
            <button type="submit" name="category" value="Kayaking" th:classappend="${param.category == 'Kayaking'} ? 'active'">Kayaking</button>
            <button type="submit" name="category" value="Hiking" th:classappend="${param.category == 'Hiking'} ? 'active'">Hiking</button>
            <button type="submit" name="category" value="Wildlife Tour" th:classappend="${param.category == 'Wildlife Tour'} ? 'active'">Wildlife Tour</button>
            <button type="submit" name="category" value="Climbing" th:classappend="${param.category == 'Climbing'} ? 'active'">Climbing</button>

            <button type="button" id="open-filters" class="filter-btn-inline">More Filters</button>
        </div>
    </form>


    <!-- FILTER PANEL -->
    <div id="filter-panel" class="filter-panel">
        <div class="filter-header">
            <h3>More Filters</h3>
            <button type="button" id="close-filters" class="close-btn">‚úï</button>
        </div>

        <form th:action="@{/events/search}" method="get" class="filter-form">
            <input type="hidden" name="q" th:value="${param.q}">
            <!-- location -->
            <div class="filter-group">
                <label>Location</label>
                <input list="location-list" name="location" th:value="${param.location}" placeholder="Enter a location...">
                <datalist id="location-list">
                    <option value="Vienna"><option value="Salzburg"><option value="Innsbruck">
                    <option value="Graz"><option value="Dornbirn">
                </datalist>
            </div>

            <!-- Category -->
            <div class="filter-group">
                <label>Category</label>
                <select name="category">
                    <option value="" th:selected="${param.category == null}">All Categories</option>
                    <option value="Hiking" th:selected="${param.category == 'Hiking'}">Hiking</option>
                    <option value="Camping" th:selected="${param.category == 'Camping'}">Camping</option>
                    <option value="Kayaking" th:selected="${param.category == 'Kayaking'}">Kayaking</option>
                    <option value="Climbing" th:selected="${param.category == 'Climbing'}">Climbing</option>
                    <option value="Wildlife Tour" th:selected="${param.category == 'Wildlife Tour'}">Wildlife Tour</option>
                </select>
            </div>

            <!-- Dates -->
            <div class="filter-group">
                <label>Date Range</label>
                <div class="date-range">
                    <input type="date" name="startDate" th:value="${param.startDate}">
                    <span>to</span>
                    <input type="date" name="endDate" th:value="${param.endDate}">
                </div>
            </div>

            <!-- Difficulty -->
            <div class="filter-group">
                <label>Difficulty</label>
                <div class="checkbox-group">
                    <label><input type="radio" name="difficulty" value="" th:checked="${param.difficulty == null}">Any</label>
                    <label><input type="radio" name="difficulty" value="BEGINNER" th:checked="${param.difficulty == 'BEGINNER'}">Beginner</label>
                    <label><input type="radio" name="difficulty" value="INTERMEDIATE" th:checked="${param.difficulty == 'INTERMEDIATE'}">Intermediate</label>
                    <label><input type="radio" name="difficulty" value="ADVANCED" th:checked="${param.difficulty == 'ADVANCED'}">Advanced</label>
                </div>
            </div>

            <!-- Price -->
            <div class="filter-group">
                <label>Price Range (‚Ç¨)</label>
                <div class="price-range">
                    <input type="number" name="minPrice" th:value="${param.minPrice}" placeholder="Min">
                    <span>‚Äì</span>
                    <input type="number" name="maxPrice" th:value="${param.maxPrice}" placeholder="Max">
                </div>
            </div>

            <button class="apply-btn" type="submit">Apply Filters</button>
        </form>
    </div>

    <div id="overlay" class="overlay"></div>


    <!-- META, GRID, CARDS -->
    <div class="event-meta-bar">
        <div class="event-count">
            <span th:text="${#lists.size(events)} + ' Events found'">0 Events found</span>
        </div>

        <div class="sort-options">
            <form th:action="@{/events/search}" method="get">
                <input type="hidden" name="q" th:value="${param.q}">
                <input type="hidden" name="category" th:value="${param.category}">

                <div class="sort-select-wrapper">
                    <label>Sort by:</label>
                    <select name="sort" onchange="this.form.submit()">
                        <option value="" th:selected="${sort == null}">Default</option>
                        <option value="dateAsc" th:selected="${sort == 'dateAsc'}">Date: Soonest First</option>
                        <option value="dateDesc" th:selected="${sort == 'dateDesc'}">Date: Latest First</option>
                        <option value="priceAsc" th:selected="${sort == 'priceAsc'}">Price: Low ‚Üí High</option>
                        <option value="priceDesc" th:selected="${sort == 'priceDesc'}">Price: High ‚Üí Low</option>
                    </select>
                </div>
            </form>
        </div>
    </div>


    <!-- EVENT GRID -->
    <div class="event-grid">

        <div class="event-card"
             th:each="event : ${events}"
             th:with="eventStart=${event.date.atTime(event.startTime)},
                      expired=${eventStart.isBefore(#temporals.createNow())}"
             th:classappend="${event.cancelled} ? 'cancelled-event' : (expired ? 'expired-event' : '')">

            <div class="card-image">
                <img th:src="${event.imageUrl != null} ? ${event.imageUrl} : @{/images/default_event.jpg}">
                <span class="tag"
                      th:text="${event.category != null ? event.category : 'General'}"
                      th:classappend="|tag-${#strings.replace(#strings.toLowerCase(event.category ?: 'general'), ' ', '-')}|">
                </span>

                <span th:if="${event.cancelled}" class="cancelled-badge">CANCELLED</span>
                <span th:if="${!event.cancelled and expired}" class="expired-badge">EXPIRED</span>
            </div>

            <div class="card-content">

                <div class="card-header">
                    <h3 th:text="${event.title}">Event</h3>
                    <span class="difficulty"
                          th:classappend="| ${#strings.toLowerCase(event.difficulty)}|"
                          th:text="${event.difficulty}">
                    </span>
                </div>

                <p th:text="${event.description}"></p>

                <ul class="details">
                    <li><i data-lucide="calendar"></i><span th:text="${#temporals.format(event.date, 'MMMM dd, yyyy')}"></span></li>
                    <li><i data-lucide="clock"></i>
                        <span th:text="${#temporals.format(event.startTime, 'HH:mm')} + ' - ' + ${#temporals.format(event.endTime, 'HH:mm')}"></span>
                    </li>
                    <li><i data-lucide="map-pin"></i><span th:text="${event.location}"></span></li>
                    <li><i data-lucide="users"></i>
                        <span th:text="${event.minParticipants} + ' - ' + ${event.maxParticipants} + ' Participants'"></span>
                    </li>
                </ul>

                <div class="footer">
                    <span class="price" th:text="'‚Ç¨ ' + ${#numbers.formatDecimal(event.price, 1, 2)}"></span>
                    <div class="buttons">
                        <a th:href="@{/events/{id}(id=${event.id})}" class="view-btn">View Details</a>

                        <th:block th:unless="${event.cancelled or expired}">
                            <a sec:authorize="hasAnyRole('ADMIN','FRONT')" th:href="@{/events/{id}/edit(id=${event.id})}" class="edit-btn">Edit</a>

                            <th:block sec:authorize="hasRole('ORGANIZER')">
                                <a th:if="${currentUserName != null && event.organizer != null && #strings.equalsIgnoreCase(currentUserName, event.organizer)}"
                                   th:href="@{/events/{id}/edit(id=${event.id})}" class="edit-btn">Edit</a>
                            </th:block>

                            <form sec:authorize="hasRole('ADMIN')" th:action="@{/events/{id}/cancel(id=${event.id})}"
                                  method="post" style="display:inline;">
                                <button class="cancel-btn" onclick="return confirm('Cancel event?')">Cancel</button>
                            </form>

                            <form sec:authorize="hasRole('ORGANIZER')"
                                  th:if="${currentUserName != null && event.organizer != null && #strings.equalsIgnoreCase(currentUserName, event.organizer)}"
                                  th:action="@{/events/{id}/cancel(id=${event.id})}"
                                  method="post" style="display:inline;">
                                <button class="cancel-btn" onclick="return confirm('Cancel event?')">Cancel</button>
                            </form>
                        </th:block>

                    </div>
                </div>
            </div>
        </div>

    </div>

</section>

<script src="https://unpkg.com/lucide@latest"></script>
<script>
    lucide.createIcons();

    const openBtn = document.getElementById("open-filters");
    const closeBtn = document.getElementById("close-filters");
    const panel = document.getElementById("filter-panel");
    const overlay = document.getElementById("overlay");

    openBtn?.addEventListener("click", () => { panel.classList.add("open"); overlay.classList.add("active"); });
    closeBtn?.addEventListener("click", () => { panel.classList.remove("open"); overlay.classList.remove("active"); });
    overlay?.addEventListener("click", () => { panel.classList.remove("open"); overlay.classList.remove("active"); });
</script>

</body>
</html>
