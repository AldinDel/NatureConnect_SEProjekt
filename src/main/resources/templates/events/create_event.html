<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${isEdit} ? 'Edit Event' : 'Create Event'">Create Event</title>

    <!-- Styles laden - navbar.css first for consistency -->
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="icon" type="image/png" th:href="@{/images/NatureConnectLogo.png}">

    <style>
        /* Formular Styles */
        .event-form-wrap {
            max-width: 980px;
            margin: 48px auto;
            padding: 0 16px;
            margin-top: 120px; /* Abstand für die Navbar */
        }
        .event-form-title { font-size: 28px; font-weight: 700; color: #fff; margin: 0 0 18px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .event-form-hr { height: 1px; background: rgba(255,255,255,0.3); border: 0; margin: 0 0 28px; }

        .event-form {
            display: grid; grid-template-columns: 1fr 1fr; gap: 24px 40px;
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-label { font-size: 14px; color: #1c2a3a; font-weight: 600; }
        .form-input, .form-select, .form-textarea { width: 100%; background: #fff; border: 1px solid #d7dbe2; border-radius: 8px; padding: 10px 12px; font-size: 14px; color: #1b1b1b; outline: none; }
        .form-textarea { min-height: 110px; resize: vertical; }
        .form-span-2 { grid-column: 1 / -1; }

        .photo-card { background: #f4f5f7; border: 1px solid #d7dbe2; border-radius: 10px; min-height: 180px; display: flex; align-items: center; justify-content: center; color: #9aa4b2; overflow: hidden; position: relative; padding: 12px; }
        .photo-card img { max-width: 100%; max-height: 300px; object-fit: contain; border-radius: 6px; }

        .upload-btn { margin-top: 12px; padding: 8px 14px; border-radius: 999px; background: #0f2740; color: #fff; border: none; cursor: pointer; width: 100%; }
        .upload-btn:hover { background: #1a3a5c; }

        .form-actions { grid-column: 1/-1; display: flex; gap: 15px; margin-top: 10px; justify-content: center; }

        .equipment-item { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; background: #f9fafb; padding: 8px; border-radius: 6px; border: 1px solid #eee; }
        .remove-equipment { background: none; border: none; color: #dc2626; font-weight: bold; cursor: pointer; font-size: 16px; }

        .time-inputs { display: flex; gap: 10px; align-items: center; }
    </style>
</head>

<body>

<!-- HIER WIRD DIE GLOBALE NAVBAR GELADEN -->
<div th:replace="~{events/fragments/navbar :: navbar}"></div>

<main class="event-form-wrap">
    <h1 class="event-form-title" th:text="${isEdit} ? 'Edit Event' : 'Create Event'">Create Event</h1>
    <hr class="event-form-hr">

    <form class="event-form"
          th:action="${isEdit} ? @{/events/{id}(id=${id})} : @{/events}"
          th:object="${event}"
          method="post"
          enctype="multipart/form-data">

        <!-- Foto Upload -->
        <div class="form-group">
            <label class="form-label">Photo:</label>
            <div id="photoCard" class="photo-card">
                <img th:if="${event.imageUrl != null and event.imageUrl != ''}" th:src="@{${event.imageUrl}}">
                <span id="photoHint" th:if="${event.imageUrl == null or event.imageUrl == ''}">Image preview</span>
            </div>
            <input type="file" name="photo" id="photo" accept="image/*" style="display:none">
            <input type="hidden" name="imageUrl" id="imageUrl" th:value="${event.imageUrl}">
            <button type="button" class="upload-btn" onclick="document.getElementById('photo').click()">Upload Photo</button>
        </div>

        <!-- Titel -->
        <div class="form-group">
            <label class="form-label">Title:</label>
            <input id="title" name="title" th:field="*{title}" class="form-input" required>
        </div>

        <!-- Organizer (Readonly wenn nicht Admin) -->
        <div class="form-group">
            <label class="form-label">Organizer:</label>
            <input id="organizer" name="organizer" th:field="*{organizer}" class="form-input"
                   th:readonly="${!#authorization.expression('hasRole(''ADMIN'')')}">
        </div>

        <!-- Kategorie -->
        <div class="form-group">
            <label class="form-label">Category:</label>
            <select id="category" name="category" th:field="*{category}" class="form-select">
                <option value="">Select…</option>
                <option value="Hiking">Hiking</option>
                <option value="Camping">Camping</option>
                <option value="Climbing">Climbing</option>
                <option value="Kayaking">Kayaking</option>
                <option value="Wildlife Tour">Wildlife Tour</option>
            </select>
        </div>

        <!-- Beschreibung -->
        <div class="form-group form-span-2">
            <label class="form-label">Description:</label>
            <textarea id="description" name="description" th:field="*{description}" class="form-textarea"></textarea>
        </div>

        <!-- Datum & Zeit -->
        <div class="form-group">
            <label class="form-label">Date:</label>
            <input id="date" name="date" type="date" class="form-input" th:value="${event.date}" required>
        </div>
        <div class="form-group">
            <label class="form-label">Time:</label>
            <div class="time-inputs">
                <input id="startTime" name="startTime" type="time" th:value="${event.startTime}" class="form-input" required>
                <span>to</span>
                <input id="endTime" name="endTime" type="time" th:value="${event.endTime}" class="form-input" required>
            </div>
        </div>

        <!-- Ort & Schwierigkeit -->
        <div class="form-group">
            <label class="form-label">Location:</label>
            <input id="location" name="location" th:field="*{location}" class="form-input" required>
        </div>
        <div class="form-group">
            <label class="form-label">Difficulty:</label>
            <select id="difficulty" name="difficulty" th:field="*{difficulty}" class="form-select" required>
                <option value="BEGINNER">Beginner</option>
                <option value="INTERMEDIATE">Intermediate</option>
                <option value="ADVANCED">Advanced</option>
            </select>
        </div>

        <!-- Teilnehmer -->
        <div class="form-group">
            <label class="form-label">Min participants:</label>
            <input id="minParticipants" name="minParticipants" type="number" min="1" th:field="*{minParticipants}" class="form-input" required>
        </div>
        <div class="form-group">
            <label class="form-label">Max participants:</label>
            <input id="maxParticipants" name="maxParticipants" type="number" min="1" th:field="*{maxParticipants}" class="form-input" required>
        </div>

        <!-- Equipment -->
        <div class="form-group form-span-2">
            <label class="form-label">Equipment:</label>
            <div id="equipment-list"></div>
            <button type="button" id="add-equipment" class="upload-btn" style="background: #fff; color: #0f2740; border: 1px solid #ccc; width: auto; margin-top: 5px;">+ Add Equipment</button>
        </div>

        <!-- Audience & Price -->
        <div class="form-group">
            <label class="form-label">Audience:</label>
            <select id="audience" name="audience" th:field="*{audience}" class="form-select" required>
                <option value="INDIVIDUALS_GROUPS_COMPANIES">Individuals, Groups, Companies</option>
                <option value="GROUPS_COMPANIES">Groups, Companies</option>
                <option value="INDIVIDUALS_ONLY">Individuals only</option>
                <option value="COMPANIES_ONLY">Companies only</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Price (€):</label>
            <input id="price" name="price" type="number" min="0" step="0.01" th:field="*{price}" class="form-input" required>
        </div>

        <!-- Buttons -->
        <div class="form-actions">
            <button type="submit" class="btn-primary" style="background: #0f2740; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;">Save Event</button>
            <a th:href="@{/events}" class="btn-ghost" style="padding: 10px 20px; color: #555; text-decoration: none;">Cancel</a>
        </div>
    </form>
</main>

<!-- JS Scripts -->
<script th:inline="javascript">
    /* Equipment JS Logic here (gekürzt, da schon vorhanden) */
    document.addEventListener("DOMContentLoaded", function () {
        const equipmentList = document.getElementById("equipment-list");
        const addButton = document.getElementById("add-equipment");
        const serverEquipment = /*[[${eventEquipments}]]*/ [];
        let eqIndex = 0;

        function createEquipmentRow(eq = {}) {
            const item = document.createElement("div");
            item.classList.add("equipment-item");
            const index = eqIndex++;
            const isRentable = eq.rentable === true;
            const isRequired = eq.required === true;

            item.innerHTML = `
                <input type="hidden" name="equipments[${index}].id" value="${eq.id || ''}">
                <input type="text" name="equipments[${index}].name" class="form-input" placeholder="Name" value="${eq.name || ''}" required style="flex:2">
                <input type="number" name="equipments[${index}].unitPrice" class="form-input" placeholder="Price" step="0.01" value="${eq.unitPrice || ''}" style="flex:1">
                <input type="number" name="equipments[${index}].stock" class="form-input" placeholder="Stock" value="${eq.stock || ''}" style="flex:1">
                <label style="font-size:13px"><input type="checkbox" name="equipments[${index}].rentable" value="true" ${isRentable ? 'checked' : ''}> Rentable</label>
                <label style="font-size:13px"><input type="checkbox" name="equipments[${index}].required" value="true" ${isRequired ? 'checked' : ''}> Required</label>
                <button type="button" class="remove-equipment">✕</button>
            `;
            return item;
        }

        if (serverEquipment) serverEquipment.forEach(eq => equipmentList.appendChild(createEquipmentRow(eq)));
        if (addButton) addButton.addEventListener("click", () => equipmentList.appendChild(createEquipmentRow()));
        if (equipmentList) equipmentList.addEventListener("click", e => { if(e.target.classList.contains("remove-equipment")) e.target.closest(".equipment-item").remove(); });

        // Photo Preview
        const photoInput = document.getElementById('photo');
        const photoCard = document.getElementById('photoCard');
        if (photoInput) {
            photoInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        photoCard.innerHTML = `<img src="${event.target.result}" style="max-width:100%; max-height:300px;">`;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    });
</script>

</body>
</html>