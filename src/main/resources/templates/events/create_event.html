<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="${isEdit} ? 'Edit Event' : 'Create Event'">Create Event</title>
    <link rel="stylesheet" th:href="@{/style.css}" href="/style.css" />
    <link rel="icon" type="image/png" th:href="@{/images/NatureConnectLogo.png}" href="/images/NatureConnectLogo.png">

    <style>
        .event-form-wrap { max-width: 980px; margin: 48px auto; padding: 0 16px; }
        .event-form-title { font-size: 28px; font-weight: 700; color: #0f2740; margin: 0 0 18px; }
        .event-form-hr { height: 1px; background: #e6e8ec; border: 0; margin: 0 0 28px; }
        .event-form { display: grid; grid-template-columns: 1fr 1fr; gap: 24px 40px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-label { font-size: 14px; color: #1c2a3a; }
        .form-input, .form-select, .form-textarea {
            width: 100%; background: #fff; border: 1px solid #d7dbe2; border-radius: 8px;
            padding: 10px 12px; font-size: 14px; color: #1b1b1b; outline: none;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: #89a7ff; box-shadow: 0 0 0 3px rgba(137,167,255,.25);
        }
        .form-textarea { min-height: 110px; resize: vertical; }
        .photo-card {
            background: linear-gradient(#f4f5f7,#e9ecf0);
            border:1px solid #d7dbe2;
            border-radius:10px;
            min-height:180px;
            display:flex;
            align-items: center;
            justify-content: center;
            color:#9aa4b2;
            overflow: hidden;
            position: relative;
            padding: 12px;
        }
        .photo-card img {
            max-width: 100%;
            max-height: 400px;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 6px;
        }
        .upload-btn { margin-top:12px; padding:8px 14px; border-radius:999px; background:#0f2740; color:#fff; border:none; cursor:pointer; }
        .upload-btn:hover { background:#1a3a5c; }
        .form-actions { grid-column:1/-1; display:flex; gap:10px; margin-top:8px; }
        .btn-primary{ background:#0f2740; color:#fff; border:0; border-radius:999px; padding:10px 24px; cursor:pointer; }
        .btn-primary:hover { background:#1a3a5c; }
        .btn-ghost{ background:transparent; color:#0f2740; border:1px solid #c9d1db; border-radius:999px; padding:10px 24px; cursor:pointer; text-decoration: none; display: inline-block; }
        .btn-ghost:hover { background:#f4f5f7; }
        .time-inputs { display: flex; align-items: center; gap: 12px; }
        .time-separator { color: #6b7280; font-size: 14px; }
        .form-span-2 { grid-column: 1 / -1; }
    </style>
</head>

<body class="create-event-page">

<!-- Erfolgsmeldung Popup -->
<div th:if="${success}" id="success-popup" class="popup-message" th:text="${success}"></div>
<div th:if="${error}" id="error-popup" class="popup-message error" th:text="${error}"></div>


<style>
    .popup-message {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4caf50;
        color: #fff;
        padding: 14px 22px;
        border-radius: 8px;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: fadeInOut 3s ease forwards;
        z-index: 1000;
        letter-spacing: 0.3px;
    }
    @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(-10px); }
        10%, 90% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-10px); }
    }
</style>

<script>
    // Popup automatisch ausblenden nach 3,5 Sekunden
    document.addEventListener("DOMContentLoaded", () => {
        const popup = document.getElementById("success-popup");
        if (popup) {
            setTimeout(() => {
                popup.style.display = "none";
            }, 3500);
        }
    });
</script>

<style>
    .popup-message.error {
        background: #e53935;
    }
</style>

<!--bestehender Header-->
<header class="nc-header">
    <div class="nc-container">
        <a class="nc-logo" th:href="@{/}" href="/" aria-label="NATUREConnect Home">
            <img src="/images/NatureConnectLogo.png" alt="Logo">
            <span class="nc-brand"><strong>NATURE</strong>Connect</span>
        </a>
        <!-- Trennlinie -->
        <div class="nc-divider"></div>

        <nav class="nc-nav" aria-label="Primary">
            <ul class="nc-left">
                <li><a th:href="@{/}" href="/">Home</a></li>
                <li class="dropdown">
                    <a href="#" class="dropbtn">Events ▾</a>
                    <ul class="dropdown-content">
                        <li><a th:href="@{/events}" href="/events">Events</a></li>
                        <li><a th:href="@{/events/new}" href="/events/new">Create Event</a></li>
                    </ul>
                </li>
            </ul>
            <ul class="nc-right">
                <li><a th:href="@{/about}" href="/about">About Us</a></li>
                <li><span class="divider">|</span></li>
                <li><a th:href="@{/contact}" href="/contact">Contact Us</a></li>
                <li><a class="nc-login" th:href="@{/login}" href="/login">Log In</a></li>
            </ul>
        </nav>
    </div>
</header>

<main class="event-form-wrap">
    <h1 class="event-form-title" th:text="${isEdit} ? 'Edit Event' : 'Create Event'">Create Event</h1>
    <hr class="event-form-hr">

    <form class="event-form"
          th:action="${isEdit} ? @{/events/{id}(id=${event.id})} : @{/events}"
          th:object="${event}"
          method="post"
          enctype="multipart/form-data">

        <!-- Wichtig: EventEntity-ID mitsenden, damit das Update funktioniert -->
        <input type="hidden" th:if="${isEdit}" th:field="*{id}">

        <!-- PHOTO -->
        <div class="form-group">
            <label class="form-label">Photo:</label>
            <div id="photoCard" class="photo-card">
                <img th:if="${event.imageUrl}" th:src="${event.imageUrl}" alt="Event Photo">
                <span id="photoHint" th:unless="${event.imageUrl}">Image preview</span>
            </div>
            <input type="file" name="photo" id="photo" accept="image/*" style="display:none">
            <input type="hidden" name="imageUrl" id="imageUrl" th:value="${event.imageUrl}">
            <span id="photoUploadStatus" style="font-size:12px;color:#555;"></span>
            <button type="button" class="upload-btn" onclick="document.getElementById('photo').click()">Upload Photo</button>
        </div>

        <!-- Titel -->
        <div class="form-group">
            <label class="form-label" for="title">Title:</label>
            <input id="title" name="title" th:field="*{title}" class="form-input" required>
        </div>

        <!-- Organizer -->
        <div class="form-group">
            <label class="form-label" for="organizer">Organizer:</label>
            <input id="organizer" name="organizer" th:field="*{organizer}" class="form-input" placeholder="e.g., John Doe / Mountain Adventures">
        </div>

        <!-- Category -->
        <div class="form-group">
            <label class="form-label" for="category">Category:</label>
            <select id="category" name="category" th:field="*{category}" class="form-select">
                <option value="">Select…</option>
                <option value="Hiking">Hiking</option>
                <option value="Camping">Camping</option>
                <option value="Climbing">Climbing</option>
                <option value="Kayaking">Kayaking</option>
                <option value="Wildlife Tour">Wildlife Tour</option>
            </select>
        </div>

        <!-- Description -->
        <div class="form-group form-span-2">
            <label class="form-label" for="description">Description:</label>
            <textarea id="description" name="description" th:field="*{description}" class="form-textarea"></textarea>
        </div>

        <!-- Date -->
        <div class="form-group">
            <label class="form-label" for="date">Date:</label>
            <input id="date" name="date" type="date" th:field="*{date}" class="form-input" required>
        </div>

        <!-- Time range -->
        <div class="form-group time-range">
            <label class="form-label">Time:</label>
            <div class="time-inputs">
                <input id="startTime" name="startTime" type="time"
                       th:value="${#strings.substring(event.startTime, 0, 5)}"
                       class="form-input" required>

                <span class="time-separator">to</span>

                <input id="endTime" name="endTime" type="time"
                       th:value="${#strings.substring(event.endTime, 0, 5)}"
                       class="form-input" required>
            </div>
        </div>

        <!-- Location -->
        <div class="form-group">
            <label class="form-label" for="location">Location:</label>
            <input id="location" name="location" th:field="*{location}" class="form-input" placeholder="e.g., Vienna" required>
        </div>

        <!-- Difficulty -->
        <div class="form-group">
            <label class="form-label" for="difficulty">Difficulty level:</label>
            <select id="difficulty" name="difficulty" th:field="*{difficulty}" class="form-select" required>
                <option value="">Select…</option>
                <option value="BEGINNER">Beginner</option>
                <option value="INTERMEDIATE">Intermediate</option>
                <option value="ADVANCED">Advanced</option>
            </select>
        </div>

        <!-- Min/Max Participants -->
        <div class="form-group">
            <label class="form-label" for="minParticipants">Min participants:</label>
            <input id="minParticipants" name="minParticipants" type="number" min="1" th:field="*{minParticipants}" value="1" class="form-input" placeholder="e.g., 5" required>
        </div>

        <div class="form-group">
            <label class="form-label" for="maxParticipants">Max participants:</label>
            <input id="maxParticipants" name="maxParticipants" type="number" min="1" th:field="*{maxParticipants}" class="form-input" placeholder="e.g., 20" required>
        </div>

        <!-- at.fhv.Event.infrastructure.persistence.equipment.EventEquipmentEntity -->
        <div class="form-group form-span-2">
            <label class="form-label">Equipment:</label>
            <div id="equipment-list" class="equipment-list"></div>
            <button type="button" id="add-equipment" class="btn-ghost" style="margin-top:10px;">+ Add Equipment</button>
        </div>


        <!-- Price -->
        <div class="form-group">
            <label class="form-label" for="price">Price:</label>
            <input id="price" name="price" type="number" min="0" step="0.01" th:field="*{price}" value="0" class="form-input" placeholder="e.g., 49.90" required>
        </div>

        <!-- Buttons -->
        <div class="form-actions">
            <button type="submit" class="btn-primary" th:text="${isEdit} ? 'Update' : 'Save'">Save</button>
            <a th:href="@{/events}" href="/events" class="btn-ghost">Cancel</a>
        </div>

    </form>

</main>

<script>

    // Form Validation
    const form = document.querySelector('.event-form');
    form.addEventListener('submit', function(event) {
        const minParticipants = parseInt(document.getElementById('minParticipants').value) || 0;
        const maxParticipants = parseInt(document.getElementById('maxParticipants').value) || 0;
        const startTime = document.getElementById('startTime').value;
        const endTime = document.getElementById('endTime').value;

        // Validate participants
        if (maxParticipants > 0 && minParticipants > maxParticipants) {
            event.preventDefault();
            alert('Min participants cannot be greater than max participants!');
            return;
        }

        // Validate time order
        if (startTime && endTime && endTime <= startTime) {
            event.preventDefault();
            alert('End time must be after start time!');
            return;
        }
    });
</script>

<script>
    // Cloudinary-Konfiguration
    const CLOUD_NAME = 'dwsnx7jof';
    const UPLOAD_PRESET = 'events_unsigned';
    const UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;

    const photoInput = document.getElementById('photo');
    const photoCard = document.getElementById('photoCard');
    const photoHint = document.getElementById('photoHint');
    const imageUrlInput = document.getElementById('imageUrl');
    const uploadStatus = document.getElementById('photoUploadStatus');

    photoInput.addEventListener('change', async function (event) {
        const file = event.target.files[0];
        if (!file) return;

        // Status anzeigen
        uploadStatus.textContent = 'Uploading image...';
        uploadStatus.style.color = '#555';

        try {
            const fd = new FormData();
            fd.append('file', file);
            fd.append('upload_preset', UPLOAD_PRESET);

            const res = await fetch(UPLOAD_URL, { method: 'POST', body: fd });
            const data = await res.json();

            if (!data.secure_url) {
                console.error('Cloudinary upload error:', data);
                uploadStatus.textContent = 'Upload failed.';
                uploadStatus.style.color = '#e53935';
                return;
            }

            // URL in hidden Feld schreiben
            imageUrlInput.value = data.secure_url;

            // Vorschau aktualisieren
            if (photoHint) photoHint.style.display = 'none';
            let img = photoCard.querySelector('img');
            if (!img) {
                img = document.createElement('img');
                photoCard.appendChild(img);
            }
            img.src = data.secure_url;
            img.alt = 'Event Photo';

            // Erfolg
            uploadStatus.textContent = 'Upload complete ✔';
            uploadStatus.style.color = '#2e7d32';
        } catch (err) {
            console.error(err);
            uploadStatus.textContent = 'Upload failed.';
            uploadStatus.style.color = '#e53935';
        }
    });
</script>

<!-- Note: Ab hier wurden viele Kommentare eingefügt, um den Ablauf besser zu verstehen.  -->


<!-- Ausgeführt, sobald die Seite fertig geladen ist -->
<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener("DOMContentLoaded", async () => {
        const equipmentList = document.getElementById("equipment-list");
        const addButton = document.getElementById("add-equipment");

        // JS-Fallbacks, damit die Seite auch ohne Thymeleaf nicht stirbt
        const isEdit  = /*[[${isEdit}]]*/ false;
        const eventId = /*[[${isEdit} ? ${event.id} : 0]]*/ 0;

        // Funktion zum Erstellen einer Equipment-Zeile
        function createEquipmentRow(eq = {}) {
            const item = document.createElement("div");
            item.classList.add("equipment-item");
            item.innerHTML = `
                <input type="hidden" name="equipmentIds" value="${eq.id || ""}">
                <input type="text" name="equipmentNames" class="form-input" placeholder="e.g. Tent" value="${eq.name || ""}" required>
                <input type="number"
                    name="equipmentPrices"
                    class="form-input"
                    placeholder="Price"
                    value="${eq.price != null ? eq.price : '0.00'}"
                    step="0.01"
                    style="width:120px;">
                <label><input type="checkbox" name="equipmentRentable" ${eq.rentable ? "checked" : ""}> Rentable</label>
                <label><input type="checkbox" name="requiredFlags" ${eq.required ? "checked" : ""}> Required</label>
                <button type="button" class="remove-equipment">✕</button>
            `;
            return item;
        }

        // Edit-Modus → Daten vom Backend laden
        if (isEdit && eventId) {
            try {
                const res = await fetch(`/api/events/${eventId}`);
                const data = await res.json();
                equipmentList.innerHTML = "";

                if (data.equipments && data.equipments.length > 0) {
                    data.equipments.forEach(eq => {
                        equipmentList.appendChild(createEquipmentRow(eq));
                    });
                } else {
                    equipmentList.appendChild(createEquipmentRow());
                }
            } catch (err) {
                console.error("Error loading event data:", err);
                equipmentList.appendChild(createEquipmentRow());
            }
        } else {
            // Create-Seite → direkt eine leere Zeile anzeigen
            equipmentList.appendChild(createEquipmentRow());
        }

        // Hinzufügen-Button
        addButton.addEventListener("click", () => {
            equipmentList.appendChild(createEquipmentRow());
        });

        // Entfernen-Button
        equipmentList.addEventListener("click", e => {
            if (e.target.classList.contains("remove-equipment")) {
                e.target.closest(".equipment-item").remove();
            }
        });
    });
    /*]]>*/
</script>





</body>
</html>