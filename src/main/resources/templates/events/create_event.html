<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${isEdit} ? 'Edit Event' : 'Create Event'">Create Event</title>
    <link rel="stylesheet" th:href="@{/style.css}" href="/style.css"/>
    <link rel="icon" type="image/png" th:href="@{/images/NatureConnectLogo.png}" href="/images/NatureConnectLogo.png">

    <style>
        .event-form-wrap {
            max-width: 980px;
            margin: 48px auto;
            padding: 0 16px;
        }

        .event-form-title {
            font-size: 28px;
            font-weight: 700;
            color: #0f2740;
            margin: 0 0 18px;
        }

        .event-form-hr {
            height: 1px;
            background: #e6e8ec;
            border: 0;
            margin: 0 0 28px;
        }

        .event-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px 40px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 14px;
            color: #1c2a3a;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: #fff;
            border: 1px solid #d7dbe2;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 14px;
            color: #1b1b1b;
            outline: none;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: #89a7ff;
            box-shadow: 0 0 0 3px rgba(137, 167, 255, .25);
        }

        .form-textarea {
            min-height: 110px;
            resize: vertical;
        }

        .photo-card {
            background: linear-gradient(#f4f5f7, #e9ecf0);
            border: 1px solid #d7dbe2;
            border-radius: 10px;
            min-height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9aa4b2;
            overflow: hidden;
            position: relative;
            padding: 12px;
        }

        .photo-card img {
            max-width: 100%;
            max-height: 400px;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 6px;
        }

        .upload-btn {
            margin-top: 12px;
            padding: 8px 14px;
            border-radius: 999px;
            background: #0f2740;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        .upload-btn:hover {
            background: #1a3a5c;
        }

        .form-actions {
            grid-column: 1/-1;
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .btn-primary {
            background: #0f2740;
            color: #fff;
            border: 0;
            border-radius: 999px;
            padding: 10px 24px;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: #1a3a5c;
        }

        .btn-ghost {
            background: transparent;
            color: #0f2740;
            border: 1px solid #c9d1db;
            border-radius: 999px;
            padding: 10px 24px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .btn-ghost:hover {
            background: #f4f5f7;
        }

        .time-inputs {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .time-separator {
            color: #6b7280;
            font-size: 14px;
        }

        .form-span-2 {
            grid-column: 1 / -1;
        }

        .equipment-item {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 8px;
        }

        .equipment-item input[type="text"] {
            width: 160px;
        }

        .remove-equipment {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 5px;
            cursor: pointer;
        }

        .remove-equipment:hover {
            background: #c0392b;
        }
    </style>
</head>

<body class="create-event-page">

<header class="nc-header">
    <div class="nc-container">
        <a class="nc-logo" th:href="@{/}" href="/" aria-label="NATUREConnect Home">
            <img src="/images/NatureConnectLogo.png" alt="Logo">
            <span class="nc-brand"><strong>NATURE</strong>Connect</span>
        </a>
        <div class="nc-divider"></div>
        <nav class="nc-nav" aria-label="Primary">
            <ul class="nc-left">
                <li><a th:href="@{/}" href="/">Home</a></li>
                <li class="dropdown">
                    <a href="#" class="dropbtn">Events ▾</a>
                    <ul class="dropdown-content">
                        <li><a th:href="@{/events}" href="/events">Events</a></li>
                        <li><a th:href="@{/events/new}" href="/events/new">Create Event</a></li>
                    </ul>
                </li>
            </ul>
            <ul class="nc-right">
                <li><a th:href="@{/about}" href="/about">About Us</a></li>
                <li><span class="divider">|</span></li>
                <li><a th:href="@{/contact}" href="/contact">Contact</a></li>
                <li><a class="nc-login" th:href="@{/login}" href="/login">Log In</a></li>
            </ul>
        </nav>
    </div>
</header>

<main class="event-form-wrap">
    <h1 class="event-form-title" th:text="${isEdit} ? 'Edit Event' : 'Create Event'">Create Event</h1>
    <hr class="event-form-hr">

    <form class="event-form"
          th:action="${isEdit} ? @{/events/{id}(id=${id})} : @{/events}"
          th:object="${event}"
          method="post"
          enctype="multipart/form-data">

        <div class="form-group">
            <label class="form-label">Photo:</label>
            <div id="photoCard" class="photo-card">
                <img th:if="${event.imageUrl != null and event.imageUrl != ''}"
                     th:src="@{${event.imageUrl}}"
                     alt="Event Photo">
                <span id="photoHint"
                      th:if="${event.imageUrl == null or event.imageUrl == ''}">Image preview</span>
            </div>

            <input type="file" name="photo" id="photo" accept="image/*" style="display:none">
            <input type="hidden" name="imageUrl" id="imageUrl" th:value="${event.imageUrl}">
            <span id="photoUploadStatus" style="font-size:12px;color:#555;"></span>

            <button type="button" class="upload-btn" onclick="document.getElementById('photo').click()">Upload Photo
            </button>
        </div>

        <div class="form-group">
            <label class="form-label" for="title">Title:</label>
            <input id="title" name="title" th:field="*{title}" class="form-input" required>
        </div>

        <div class="form-group">
            <label class="form-label" for="organizer">Organizer:</label>
            <input id="organizer" name="organizer" th:field="*{organizer}" class="form-input">
        </div>

        <div class="form-group">
            <label class="form-label" for="category">Category:</label>
            <select id="category" name="category" th:field="*{category}" class="form-select">
                <option value="">Select…</option>
                <option value="Hiking">Hiking</option>
                <option value="Camping">Camping</option>
                <option value="Climbing">Climbing</option>
                <option value="Kayaking">Kayaking</option>
                <option value="Wildlife Tour">Wildlife Tour</option>
            </select>
        </div>

        <div class="form-group form-span-2">
            <label class="form-label" for="description">Description:</label>
            <textarea id="description" name="description" th:field="*{description}" class="form-textarea"></textarea>
        </div>

        <div class="form-group">
            <label class="form-label" for="date">Date:</label>
            <input id="date" name="date" type="date"
                   class="form-input"
                   th:value="${event.date != null ? #temporals.format(event.date, 'yyyy-MM-dd') : ''}"
                   required>
        </div>

        <div class="form-group">
            <label class="form-label">Time:</label>
            <div class="time-inputs">
                <input id="startTime" name="startTime" type="time"
                       th:value="${event.startTime != null ? #temporals.format(event.startTime, 'HH:mm') : ''}"
                       class="form-input" required>
                <span class="time-separator">to</span>
                <input id="endTime" name="endTime" type="time"
                       th:value="${event.endTime != null ? #temporals.format(event.endTime, 'HH:mm') : ''}"
                       class="form-input" required>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label" for="location">Location:</label>
            <input id="location" name="location" th:field="*{location}" class="form-input" required>
        </div>

        <div class="form-group">
            <label class="form-label" for="difficulty">Difficulty:</label>
            <select id="difficulty" name="difficulty" th:field="*{difficulty}" class="form-select" required>
                <option value="">Select…</option>
                <option value="BEGINNER">Beginner</option>
                <option value="INTERMEDIATE">Intermediate</option>
                <option value="ADVANCED">Advanced</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label" for="minParticipants">Min participants:</label>
            <input id="minParticipants" name="minParticipants" type="number" min="1" th:field="*{minParticipants}"
                   class="form-input" required>
        </div>

        <div class="form-group">
            <label class="form-label" for="maxParticipants">Max participants:</label>
            <input id="maxParticipants" name="maxParticipants" type="number" min="1" th:field="*{maxParticipants}"
                   class="form-input" required>
        </div>


        <div class="form-group form-span-2">
            <label class="form-label">Equipment:</label>
            <div id="equipment-list"></div>
            <button type="button" id="add-equipment" class="btn-ghost" style="margin-top:10px;">+ Add Equipment</button>
        </div>

        <div class="form-group">
            <label class="form-label" for="audience">Audience:</label>
            <select id="audience" name="audience" th:field="*{audience}" class="form-select" required>
                <option value="">Select…</option>

                <option value="INDIVIDUALS_GROUPS_COMPANIES"
                        th:selected="${event.audience == 'INDIVIDUALS_GROUPS_COMPANIES'}">
                    Individuals, Groups, Companies
                </option>

                <option value="GROUPS_COMPANIES"
                        th:selected="${event.audience == 'GROUPS_COMPANIES'}">
                    Groups, Companies
                </option>

                <option value="INDIVIDUALS_ONLY"
                        th:selected="${event.audience == 'INDIVIDUALS_ONLY'}">
                    Individuals only
                </option>

                <option value="COMPANIES_ONLY"
                        th:selected="${event.audience == 'COMPANIES_ONLY'}">
                    Companies only
                </option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label" for="price">Price:</label>
            <input id="price" name="price" type="number" min="0" step="0.01" th:field="*{price}" class="form-input"
                   required>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-primary" th:text="${isEdit} ? 'Update Event' : 'Create Event'">Create
                Event
            </button>
            <a th:href="@{/events}" class="btn-ghost">Cancel</a>
        </div>
    </form>
</main>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        const equipmentList = document.getElementById("equipment-list");
        const addButton = document.getElementById("add-equipment");
        const isEdit = /*[[${isEdit}]]*/ false;
        const serverEquipment = /*[[${eventEquipments}]]*/ [];
        let eqIndex = 0;

        console.log('=== EQUIPMENT LOAD DEBUG ===');
        console.log('isEdit:', isEdit);
        console.log('serverEquipment:', serverEquipment);
        console.log('===========================');

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function createEquipmentRow(eq = {}) {
            const item = document.createElement("div");
            item.classList.add("equipment-item");
            const index = eqIndex++;

            const equipmentId = eq.id || '';
            const equipmentName = eq.name ? escapeHtml(eq.name) : '';
            const equipmentPrice = eq.unitPrice ?? eq.price ?? '';
            const equipmentStock = eq.stock ?? '';
            const isRentable = eq.rentable === true;
            const isRequired = eq.required === true;
            const rentableReadOnlyAttr = isRentable ? "" : "readonly";
            const rentableRequiredAttr = isRentable ? "required" : "";

            item.innerHTML = `
        <input type="hidden"
               name="equipments[${index}].id"
               value="${equipmentId}">

        <input type="text"
            name="equipments[${index}].name"
            class="form-input equipment-name"
            data-index="${index}"
            placeholder="Equipment Name"
            value="${equipmentName}"
            required>

        <!-- PRICE -->
                <div class="equipment-price-stock">
            <div class="equipment-price-stock-inputs">
                <!-- PRICE -->
                <input type="number"
                    name="equipments[${index}].unitPrice"
                    class="form-input equipment-price"
                    data-index="${index}"
                    placeholder="Price"
                    step="0.01"
                    min="0"
                    value="${equipmentPrice}"
                    ${rentableReadOnlyAttr}
                    ${rentableRequiredAttr}>

                <!-- STOCK -->
                <input type="number"
                    name="equipments[${index}].stock"
                    class="form-input equipment-stock"
                    data-index="${index}"
                    placeholder="Stock"
                    min="0"
                    value="${equipmentStock}"
                    ${rentableReadOnlyAttr}
                    ${rentableRequiredAttr}>
            </div>

            <div class="rentable-warning">
                Please enable "Rentable" first.
            </div>
        </div>



        <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox"
                   data-index="${index}"
                   data-field="rentable"
                   ${isRentable ? 'checked' : ''}>
            Rentable
        </label>
        <input type="hidden"
               name="equipments[${index}].rentable"
               value="${isRentable}"
               data-hidden-rentable="${index}">

        <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox"
                   data-index="${index}"
                   data-field="required"
                   ${isRequired ? 'checked' : ''}>
            Required
        </label>
        <input type="hidden"
               name="equipments[${index}].required"
               value="${isRequired}"
               data-hidden-required="${index}">

        <button type="button" class="remove-equipment">✕</button>
    `;

            return item;
        }


        function loadEquipment() {
            equipmentList.innerHTML = "";
            eqIndex = 0;

            if (isEdit && Array.isArray(serverEquipment) && serverEquipment.length > 0) {
                console.log('Loading equipment from server:', serverEquipment.length);
                serverEquipment.forEach(eq => {
                    equipmentList.appendChild(createEquipmentRow(eq));
                });
            }
        }

        // Initialize
        if (equipmentList && addButton) {
            if (isEdit) {
                loadEquipment();
            }

            equipmentList.addEventListener("change", (e) => {
                if (e.target.type === "checkbox") {
                    const index = e.target.dataset.index;
                    const field = e.target.dataset.field;
                    const hiddenInput = document.querySelector(`[data-hidden-${field}="${index}"]`);

                    if (hiddenInput) {
                        hiddenInput.value = e.target.checked;
                        console.log(` Updated ${field}[${index}] = ${e.target.checked}`);
                    }

                    //  Rentable steuert, ob Price & Stock (sichtbar/editierbar + required)
                    if (field === "rentable") {
                        const checked = e.target.checked;

                        const warning = e.target
                            .closest(".equipment-item")
                            .querySelector(".rentable-warning");

                        if (warning) warning.style.display = "none";

                        const priceInput = document.querySelector(
                            `input[name="equipments[${index}].unitPrice"]`
                        );
                        const stockInput = document.querySelector(
                            `input[name="equipments[${index}].stock"]`
                        );

                        if (priceInput) {
                            priceInput.required = checked;
                            priceInput.readOnly = !checked;
                            if (!checked) {
                                priceInput.value = "";
                            }
                        }

                        if (stockInput) {
                            stockInput.required = checked;
                            stockInput.readOnly = !checked;
                            if (!checked) {
                                stockInput.value = "";
                            }
                        }
                    }
                }
            });

            equipmentList.addEventListener("input", (e) => {
                if (e.target.matches(".equipment-name, .equipment-price, .equipment-stock")) {
                    const index = e.target.dataset.index;
                    const hiddenId = document.querySelector(
                        `input[name="equipments[${index}].id"]`
                    );

                    // Wenn es ein ursprüngliches Equipment mit ID war → ID löschen,
                    // damit Backend es als neues Equipment behandelt
                    if (hiddenId && hiddenId.value) {
                        console.log(`Clearing equipment ID for index ${index} (edited by user)`);
                        hiddenId.value = "";
                    }
                }
            });


            equipmentList.addEventListener("click", (e) => {
                if (e.target.classList.contains("remove-equipment")) {
                    e.target.closest(".equipment-item").remove();
                }
            });

            addButton.addEventListener("click", () => {
                equipmentList.appendChild(createEquipmentRow());
            });
        } else {
            console.warn('equipment-list or add-equipment not found in DOM');
        }

        // Show warning if user clicks price/stock while not rentable
        equipmentList.addEventListener("mousedown", (e) => {
            if (e.target.matches(".equipment-price, .equipment-stock")) {

                const index = e.target.dataset.index;
                const rentableCheckbox = document.querySelector(
                    `input[data-index="${index}"][data-field="rentable"]`
                );

                if (!rentableCheckbox.checked) {
                    const warning = e.target
                        .closest(".equipment-item")
                        .querySelector(".rentable-warning");

                    if (warning) {
                        warning.style.display = "block";

                        // Hide automatically after 2 seconds
                        setTimeout(() => {
                            warning.style.display = "none";
                        }, 3000);
                    }

                    // Prevent the input from getting focus
                    e.preventDefault();
                }
            }
        });


        // Photo preview
        const photoInput = document.getElementById('photo');
        const photoCard = document.getElementById('photoCard');
        const photoHint = document.getElementById('photoHint');

        if (photoInput) {
            photoInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const existingImg = photoCard.querySelector('img');
                        if (existingImg) {
                            existingImg.remove();
                        }
                        if (photoHint) {
                            photoHint.style.display = 'none';
                        }

                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.alt = 'Event Photo Preview';
                        photoCard.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    });

</script>


</body>
</html>